<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>WebSocket协议详解以及服务实现的技术总结 | 沐风技术博客</title><meta name="description" content="WebSocket协议详解以及WebSocket服务实现的技术总结WebSocket是什么？（下面简称ws） WebSocket是一种在单个TCP连接上进行全双工通信的网络传输协议。客户端与服务端完成一次握手后，两者之间可以创建持久性的连接，并进行双向数据传输。  ws技术可以解决什么什么样的业务场景问题？业务场景客户端需要持续监测服务器数据变动的业务场景下，如股票交易、抢单、即时通讯、多人协作服"><meta name="keywords" content="WebSocket,Spring"><meta name="author" content="沐风"><meta name="copyright" content="沐风"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/public/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="WebSocket协议详解以及服务实现的技术总结"><meta name="twitter:description" content="WebSocket协议详解以及WebSocket服务实现的技术总结WebSocket是什么？（下面简称ws） WebSocket是一种在单个TCP连接上进行全双工通信的网络传输协议。客户端与服务端完成一次握手后，两者之间可以创建持久性的连接，并进行双向数据传输。  ws技术可以解决什么什么样的业务场景问题？业务场景客户端需要持续监测服务器数据变动的业务场景下，如股票交易、抢单、即时通讯、多人协作服"><meta name="twitter:image" content="https://i.loli.net/2020/06/02/AU7RhwT5BvkrPqd.png"><meta property="og:type" content="article"><meta property="og:title" content="WebSocket协议详解以及服务实现的技术总结"><meta property="og:url" content="https://blog.mufeng.tech/public/2020/06/02/WebSocket%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3%E4%BB%A5%E5%8F%8A%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/"><meta property="og:site_name" content="沐风技术博客"><meta property="og:description" content="WebSocket协议详解以及WebSocket服务实现的技术总结WebSocket是什么？（下面简称ws） WebSocket是一种在单个TCP连接上进行全双工通信的网络传输协议。客户端与服务端完成一次握手后，两者之间可以创建持久性的连接，并进行双向数据传输。  ws技术可以解决什么什么样的业务场景问题？业务场景客户端需要持续监测服务器数据变动的业务场景下，如股票交易、抢单、即时通讯、多人协作服"><meta property="og:image" content="https://i.loli.net/2020/06/02/AU7RhwT5BvkrPqd.png"><meta property="article:published_time" content="2020-06-02T09:34:33.000Z"><meta property="article:modified_time" content="2020-06-02T11:20:46.774Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/public/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://blog.mufeng.tech/public/2020/06/02/WebSocket%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3%E4%BB%A5%E5%8F%8A%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/"><link rel="next" title="HashMap源码分析" href="https://blog.mufeng.tech/public/2020/05/25/HashMap%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/public/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://blog.mufeng.tech/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: true,
  islazyload: true,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/public/atom.xml" title="沐风技术博客" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/public/images/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/public/archives/"><div class="headline">文章</div><div class="length_num">6</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/public/tags/"><div class="headline">标签</div><div class="length_num">4</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/public/categories/"><div class="headline">分类</div><div class="length_num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/public/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/public/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/public/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/public/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#WebSocket协议详解以及WebSocket服务实现的技术总结"><span class="toc-text">WebSocket协议详解以及WebSocket服务实现的技术总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#WebSocket是什么？（下面简称ws）"><span class="toc-text">WebSocket是什么？（下面简称ws）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ws技术可以解决什么什么样的业务场景问题？"><span class="toc-text">ws技术可以解决什么什么样的业务场景问题？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#业务场景"><span class="toc-text">业务场景</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WS的技术背景"><span class="toc-text">WS的技术背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ws技术的优点"><span class="toc-text">ws技术的优点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ws的的协议细节"><span class="toc-text">ws的的协议细节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#典型的握手请求"><span class="toc-text">典型的握手请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#字段说明"><span class="toc-text">字段说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据帧格式"><span class="toc-text">数据帧格式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#FIN：1bit"><span class="toc-text">FIN：1bit</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RSV1-RSV2-RSV3-1-bit-each"><span class="toc-text">RSV1, RSV2, RSV3:  1 bit each</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Opcode-4bit"><span class="toc-text">Opcode: 4bit</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Mask-1bit"><span class="toc-text">Mask:  1bit</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Payload-Length-7-bits-7-16-bits-or-7-64-bits"><span class="toc-text">Payload Length:  7 bits, 7+16 bits, or 7+64 bits</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Masking-key-0-or-4-bytes-32bit"><span class="toc-text">Masking-key:  0 or 4 bytes (32bit)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Payload-data-x-y-bytes"><span class="toc-text">Payload data:  (x+y) bytes</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spring体系下如何搭建ws服务？"><span class="toc-text">spring体系下如何搭建ws服务？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#项目依赖"><span class="toc-text">项目依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#握手拦截处理器"><span class="toc-text">握手拦截处理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#消息处理器"><span class="toc-text">消息处理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Session管理器"><span class="toc-text">Session管理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置WS"><span class="toc-text">配置WS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实际开发中ws服务设计需要注意的方面"><span class="toc-text">实际开发中ws服务设计需要注意的方面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#业务层消息的确认机制"><span class="toc-text">业务层消息的确认机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#心跳机制"><span class="toc-text">心跳机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分布式多实例部署的ws服务session的共享问题"><span class="toc-text">分布式多实例部署的ws服务session的共享问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#定向分配机制"><span class="toc-text">定向分配机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MQ或总线的广播机制"><span class="toc-text">MQ或总线的广播机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://i.loli.net/2020/06/02/AU7RhwT5BvkrPqd.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/public/">沐风技术博客</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/public/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/public/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/public/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/public/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">WebSocket协议详解以及服务实现的技术总结</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-06-02 17:34:33"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-06-02</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-06-02 19:20:46"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-06-02</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/public/categories/%E5%BA%94%E7%94%A8%E6%80%BB%E7%BB%93/">应用总结</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="WebSocket协议详解以及WebSocket服务实现的技术总结"><a href="#WebSocket协议详解以及WebSocket服务实现的技术总结" class="headerlink" title="WebSocket协议详解以及WebSocket服务实现的技术总结"></a>WebSocket协议详解以及WebSocket服务实现的技术总结</h1><h2 id="WebSocket是什么？（下面简称ws）"><a href="#WebSocket是什么？（下面简称ws）" class="headerlink" title="WebSocket是什么？（下面简称ws）"></a>WebSocket是什么？（下面简称ws）</h2><blockquote>
<p>WebSocket是一种在<strong>单个TCP</strong>连接上进行<strong>全双工</strong>通信的网络传输协议。客户端与服务端完成一次握手后，两者之间可以创建持久性的连接，并进行双向数据传输。</p>
</blockquote>
<h2 id="ws技术可以解决什么什么样的业务场景问题？"><a href="#ws技术可以解决什么什么样的业务场景问题？" class="headerlink" title="ws技术可以解决什么什么样的业务场景问题？"></a>ws技术可以解决什么什么样的业务场景问题？</h2><h3 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h3><p>客户端需要持续监测服务器数据变动的业务场景下，如股票交易、抢单、即时通讯、多人协作服务等。这些业务场景对于消息的即时性有很高的要求，而且还要保证消息的可靠传递</p>
<h2 id="WS的技术背景"><a href="#WS的技术背景" class="headerlink" title="WS的技术背景"></a>WS的技术背景</h2><p>在ws协议出现之前，对于实时性要求高的业务场景往往采用的是基于<strong>HTPP</strong>协议的的轮询技术。也就是每隔一段时间向服务器发送请求，如果有最新的数据就返回给客户端。这种传统的模式有很明显的缺点，即客户端向服务器不断的发送请求，然而HTTP请求与回复的过程中包含很多较长的<strong>头部</strong>（因为HTTP协议是基于文本的协议），其中真正有效的数据可能只是很小的一部分，会导致消耗很多无效的带宽资源。而且消息的实时性的指标与轮询的频率成正相关，但是频率越高所消耗的带宽资源就越高，随着互联网用户规模的庞大，显然遇到了瓶颈。</p>
<p>对于HTTP轮询协议的改进，就出现了Comet技术。Comet中普遍采用的<a href="https://zh.wikipedia.org/wiki/HTTP持久链接" target="_blank" rel="noopener">HTTP长连接</a>也会消耗服务器资源。本质上是将HTTP连接的超时时间强制延长，来减少带宽的浪费，但本质上还是HTTP技术，需要反复的发出请求。</p>
<p>ws技术的出现解决了上面的问题。ws通过兼容HTTP协议常用的80和443端口来实现客户端和服务器的双向通信，可以绕过大多数防火墙的限制。</p>
<h2 id="ws技术的优点"><a href="#ws技术的优点" class="headerlink" title="ws技术的优点"></a>ws技术的优点</h2><ul>
<li>减少控制开销，消息头部只有2至10字节，相比于HTTP协议的头部明显减少</li>
<li>更强的实时性，由于是全双工的通道，在客户端和服务可以同时向对方发送消息，相对于HTTP请求需要等待客户端发起请求服务端才能响应，延迟明显更少</li>
<li>保持连接状态（有状态的连接），ws和http协议的不同点就是，http协议是无状态的协议，业务上为了保证连接的状态，每次进行通信都会携带状态消息（如身份认证等）。而ws协议是有状态协议，彼此之间通信无需重复传递状态消息</li>
<li>可以传输二进制数据，相对HTTP，可以更轻松地处理二进制内容。</li>
</ul>
<h2 id="ws的的协议细节"><a href="#ws的的协议细节" class="headerlink" title="ws的的协议细节"></a>ws的的协议细节</h2><p>ws连接的创建需要客户端首先发起请求连接，而握手请求使用的是HTTP协议。在客户端的请求头上的<strong>Upgrade</strong>字段是<strong>websocket</strong>，表明需要升级为ws协议进行通讯。服务器在收到请求后，返回101状态码表示服务理解了客户端的请求，并将通过Upgrade消息头通知客户端采用不同的协议来完成这个请求。</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://i.loli.net/2020/06/02/AU7RhwT5BvkrPqd.png" alt="WebSocket握手时序图"></p>
<h3 id="典型的握手请求"><a href="#典型的握手请求" class="headerlink" title="典型的握手请求"></a>典型的握手请求</h3><p>客户端HTTP请求</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/chat</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: server.example.com</span><br><span class="line"><span class="attribute">Upgrade</span>: websocket</span><br><span class="line"><span class="attribute">Connection</span>: Upgrade</span><br><span class="line"><span class="attribute">Sec-WebSocket-Key</span>: dGhlIHNhbXBsZSBub25jZQ==</span><br><span class="line"><span class="attribute">Origin</span>: http://example.com</span><br><span class="line"><span class="attribute">Sec-WebSocket-Protocol</span>: chat, superchat</span><br><span class="line"><span class="attribute">Sec-WebSocket-Version</span>: 13</span><br></pre></td></tr></table></figure>

<p>服务端响应</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">101</span> Switching Protocols</span><br><span class="line"><span class="attribute">Upgrade</span>: websocket</span><br><span class="line"><span class="attribute">Connection</span>: Upgrade</span><br><span class="line"><span class="attribute">Sec-WebSocket-Accept</span>: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span><br><span class="line"><span class="attribute">Sec-WebSocket-Protocol</span>: chat</span><br></pre></td></tr></table></figure>

<h3 id="字段说明"><a href="#字段说明" class="headerlink" title="字段说明"></a>字段说明</h3><ul>
<li>Connection必须设置Upgrade，表示客户端希望连接升级</li>
<li>Upgrade字段必须设置Websocket，表示希望升级到Websocket协议。</li>
<li>Sec-WebSocket-Key是随机的字符串，服务器端会用这些数据来构造出一个SHA-1的信息摘要。把“Sec-WebSocket-Key”加上一个特殊字符串“258EAFA5-E914-47DA-95CA-C5AB0DC85B11”，然后计算<a href="https://zh.wikipedia.org/wiki/SHA-1" target="_blank" rel="noopener">SHA-1</a>摘要，之后进行<a href="https://zh.wikipedia.org/wiki/Base64" target="_blank" rel="noopener">Base64</a>编码，将结果做为“Sec-WebSocket-Accept”头的值，返回给客户端。如此操作，可以尽量避免普通HTTP请求被误认为Websocket协议。</li>
<li>Sec-WebSocket-Version 表示支持的Websocket版本。RFC6455要求使用的版本是13，之前草案的版本均应当弃用。</li>
<li>Origin字段是可选的，通常用来表示在浏览器中发起此Websocket连接所在的页面，类似于<a href="https://zh.wikipedia.org/wiki/HTTP来源地址" target="_blank" rel="noopener">Referer</a>。但是，与Referer不同的是，Origin只包含了协议和主机名称。</li>
<li>其他一些定义在HTTP协议中的字段，如<a href="https://zh.wikipedia.org/wiki/Cookie" target="_blank" rel="noopener">Cookie</a>等，也可以在Websocket中使用。</li>
</ul>
<h3 id="数据帧格式"><a href="#数据帧格式" class="headerlink" title="数据帧格式"></a>数据帧格式</h3><p>从左到右，单位是Bit，<a href="https://tools.ietf.org/html/rfc6455#section-5.2" target="_blank" rel="noopener">RFC6455参考，5.2章节</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> 0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-------+-+-------------+-------------------------------+</span><br><span class="line">|F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span><br><span class="line">|I|S|S|S|  (4)  |A|     (7)     |             (16&#x2F;64)           |</span><br><span class="line">|N|V|V|V|       |S|             |   (if payload len&#x3D;&#x3D;126&#x2F;127)   |</span><br><span class="line">| |1|2|3|       |K|             |                               |</span><br><span class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span><br><span class="line">|     Extended payload length continued, if payload len &#x3D;&#x3D; 127  |</span><br><span class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</span><br><span class="line">|                               |Masking-key, if MASK set to 1  |</span><br><span class="line">+-------------------------------+-------------------------------+</span><br><span class="line">| Masking-key (continued)       |          Payload Data         |</span><br><span class="line">+-------------------------------- - - - - - - - - - - - - - - - +</span><br><span class="line">:                     Payload Data continued ...                :</span><br><span class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span><br><span class="line">|                     Payload Data continued ...                |</span><br><span class="line">+---------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<h5 id="FIN：1bit"><a href="#FIN：1bit" class="headerlink" title="FIN：1bit"></a>FIN：1bit</h5><p>如果是1代表这是单条消息，没有后续分片了。而如果是0代表，代表此数据帧是不是一个完整的消息，而是一个消息的分片，并且不是最后一个分片后面还有其他分片</p>
<h5 id="RSV1-RSV2-RSV3-1-bit-each"><a href="#RSV1-RSV2-RSV3-1-bit-each" class="headerlink" title="RSV1, RSV2, RSV3:  1 bit each"></a>RSV1, RSV2, RSV3:  1 bit each</h5><p>必须是0，除非客户端和服务端使用WS扩展时，可以为非0。</p>
<h5 id="Opcode-4bit"><a href="#Opcode-4bit" class="headerlink" title="Opcode: 4bit"></a>Opcode: 4bit</h5><p>这个为操作码，表示对后面的有效数据荷载的具体操作，如果未知接收端需要断开连接</p>
<ul>
<li><p>％x0：表示连续帧</p>
</li>
<li><p>％x1：表示文本帧</p>
</li>
<li><p>％x2：表示二进制帧</p>
</li>
<li><p>％x3-7：保留用于其他非控制帧</p>
</li>
<li><p>％x8：表示连接关闭</p>
</li>
<li><p>％x9：表示ping操作</p>
</li>
<li><p>％xA：表示pong操作</p>
</li>
<li><p>％xB-F：保留用于其他控制帧</p>
</li>
</ul>
<h5 id="Mask-1bit"><a href="#Mask-1bit" class="headerlink" title="Mask:  1bit"></a>Mask:  1bit</h5><p>是否进行过掩码，比如客户端给服务端发送消息，需要进行掩码操作。而服务端到客户端不需要</p>
<h5 id="Payload-Length-7-bits-7-16-bits-or-7-64-bits"><a href="#Payload-Length-7-bits-7-16-bits-or-7-64-bits" class="headerlink" title="Payload Length:  7 bits, 7+16 bits, or 7+64 bits"></a>Payload Length:  7 bits, 7+16 bits, or 7+64 bits</h5><p>“有效载荷数据”的长度（以字节为单位）：如果为0-125，则为有效载荷长度。 如果为126，则以下2个字节解释为16位无符号整数是有效载荷长度。 如果是127，以下8个字节解释为64位无符号整数（最高有效位必须为0）是有效载荷长度。 多字节长度数量以网络字节顺序表示。 注意在所有情况下，必须使用最小字节数进行编码长度，例如124字节长的字符串的长度不能编码为序列126、0、124。有效载荷长度是“扩展数据”的长度+“应用程序数据”。 “扩展数据”的长度可以是零，在这种情况下，有效负载长度是 “应用程序数据”。</p>
<h5 id="Masking-key-0-or-4-bytes-32bit"><a href="#Masking-key-0-or-4-bytes-32bit" class="headerlink" title="Masking-key:  0 or 4 bytes (32bit)"></a>Masking-key:  0 or 4 bytes (32bit)</h5><p>所有从客户端传送到服务端的数据帧，数据载荷都进行了掩码操作，Mask为1，且携带了4字节的Masking-key。如果Mask为0，则没有Masking-key。</p>
<h5 id="Payload-data-x-y-bytes"><a href="#Payload-data-x-y-bytes" class="headerlink" title="Payload data:  (x+y) bytes"></a>Payload data:  (x+y) bytes</h5><p>“有效载荷数据”定义为串联的“Extension data”与“Application data”。</p>
<ul>
<li>Extension data:  x bytes</li>
</ul>
<p>如果没有协商使用扩展的话，扩展数据数据为0字节。所有的扩展都必须声明扩展数据的长度，或者可以如何计算出扩展数据的长度。此外，扩展如何使用必须在握手阶段就协商好。如果扩展数据存在，那么载荷数据长度必须将扩展数据的长度包含在内。</p>
<ul>
<li>Application data:  y bytes</li>
</ul>
<p>任意的应用数据，在扩展数据之后（如果存在扩展数据），占据了数据帧剩余的位置。载荷数据长度 减去 扩展数据长度，就得到应用数据的长度。</p>
<h2 id="spring体系下如何搭建ws服务？"><a href="#spring体系下如何搭建ws服务？" class="headerlink" title="spring体系下如何搭建ws服务？"></a>spring体系下如何搭建ws服务？</h2><p>采用SpringBoot搭建WS服务</p>
<h3 id="项目依赖"><a href="#项目依赖" class="headerlink" title="项目依赖"></a>项目依赖</h3><p>POM.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 需要的依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://i.loli.net/2020/06/02/lHDMrcfYRLVNhQI.png" alt=""></p>
<p>可以看到<code>srping-boot-starter-websocket</code>包含了<code>spring-boot-starter-web</code>，所以我们不需要再引入服务器依赖。其中还用到了，<code>spring-message</code>和<code>spring-websocket</code></p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://i.loli.net/2020/06/02/ZTq4EOUHWPIz2h5.png" alt=""></p>
<p>可以看到<code>srping-boot-starter-websocket</code>默认使用tomcat作为web服务器，所以我们后续可以进行HTTP接口的开发</p>
<p>依赖搞定之后需要，进行ws服务的实现。要实现ws服务器，需要实现一下几个部分，与上面的ws通讯过程对应</p>
<ol>
<li>握手拦截处理器</li>
<li>消息处理器</li>
<li>Session管理器（可选，简单应用可以不用session管理器）</li>
<li>WS配置Bean</li>
</ol>
<h3 id="握手拦截处理器"><a href="#握手拦截处理器" class="headerlink" title="握手拦截处理器"></a>握手拦截处理器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">握手处理器，用于客户端的握手请求</span></span><br><span class="line"><span class="comment">需要实现HandshakeInterceptor接口并注册成spring的一个Bean</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomHandshakeInterceptor</span> <span class="keyword">implements</span> <span class="title">HandshakeInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String TOKEN = <span class="string">"token"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String CHANNEL_ID = <span class="string">"channelId"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 握手前的调用，可在这里进行请求的校验工作（如权限的校验）</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">beforeHandshake</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      ServerHttpRequest serverHttpRequest, </span></span></span><br><span class="line"><span class="function"><span class="params">      ServerHttpResponse serverHttpResponse, </span></span></span><br><span class="line"><span class="function"><span class="params">      WebSocketHandler webSocketHandler, </span></span></span><br><span class="line"><span class="function"><span class="params">      Map&lt;String, Object&gt; attributes)</span> <span class="keyword">throws</span> Exception </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String queryString = serverHttpRequest.getURI().getQuery();</span><br><span class="line">        <span class="keyword">final</span> Map&lt;String, String&gt; queryMap = mapQueryString(queryString);</span><br><span class="line">        <span class="keyword">if</span> (queryMap.containsKey(TOKEN) &amp;&amp; queryMap.containsKey(CHANNEL_ID)) &#123;</span><br><span class="line">          <span class="comment">// attributes是可以用来绑定一些自定义的数据到当前session上，在session的整个生命周期内都可以获取到</span></span><br><span class="line">            attributes.put(TOKEN, queryMap.get(TOKEN));</span><br><span class="line">            attributes.put(CHANNEL_ID, queryMap.get(CHANNEL_ID));</span><br><span class="line">          <span class="comment">// 校验成功返回true，失败返回false，拒绝连接</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">mapQueryString</span><span class="params">(String queryString)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; paramMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(queryString)) &#123;</span><br><span class="line">            <span class="keyword">return</span> paramMap;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> String[] kvArray = queryString.split(<span class="string">"&amp;"</span>);</span><br><span class="line">        <span class="keyword">for</span> (String kv : kvArray) &#123;</span><br><span class="line">            <span class="keyword">final</span> String[] kvPair = kv.split(<span class="string">"="</span>);</span><br><span class="line">            <span class="keyword">if</span> (kvPair.length != <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            String key = kvPair[<span class="number">0</span>];</span><br><span class="line">            String value = kvPair[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotEmpty(key) &amp;&amp; StringUtils.isNotEmpty(value)) &#123;</span><br><span class="line">                paramMap.put(key, value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> paramMap;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterHandshake</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      ServerHttpRequest serverHttpRequest, </span></span></span><br><span class="line"><span class="function"><span class="params">      ServerHttpResponse serverHttpResponse, </span></span></span><br><span class="line"><span class="function"><span class="params">      WebSocketHandler webSocketHandler, </span></span></span><br><span class="line"><span class="function"><span class="params">      Exception e)</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      <span class="comment">// 握手之后调用</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="消息处理器"><a href="#消息处理器" class="headerlink" title="消息处理器"></a>消息处理器</h3><p>消息处理器是ws服务的核心处理器，客户端发送来的消息都会进来进行处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">消息处理器，用处接收来自客户端的请求</span></span><br><span class="line"><span class="comment">需要继承AbstractWebSocketHandler这个抽象类来实现自己的自定义消息处理器</span></span><br><span class="line"><span class="comment">TextWebSocketHandler是用于处理文本消息处理器，也是AbstractWebSocketHandler的派生类</span></span><br><span class="line"><span class="comment">将CustomWebSocketHandler注册成spring的一个Bean</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">Component</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomWebSocketHandler</span> <span class="keyword">extends</span> <span class="title">TextWebSocketHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> WsSessionManager wsSessionManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterConnectionEstablished</span><span class="params">(WebSocketSession session)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Object channelId = session.getAttributes().get(CustomHandshakeInterceptor.CHANNEL_ID);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(channelId)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"ID获取异常"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> Object wsTmpToken = session.getAttributes().get(CustomHandshakeInterceptor.TOKEN);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(wsTmpToken)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"认证token丢失"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 托管session</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> addSuccess = wsSessionManager.add(channelId.toString(), session);</span><br><span class="line">        <span class="keyword">if</span> (!addSuccess) &#123;</span><br><span class="line">            session.close(CloseStatus.NORMAL.withReason(<span class="string">"频道被占用，请更换频道"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 来自客户端的消息在此处理</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleTextMessage</span><span class="params">(WebSocketSession session, TextMessage message)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        log.debug(<span class="string">"客户端消息: &#123;&#125;"</span>, message.getPayload());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在连接断后后会调用该方法进行回收处理</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterConnectionClosed</span><span class="params">(WebSocketSession session, CloseStatus status)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Object channelId = session.getAttributes().get(CustomHandshakeInterceptor.CHANNEL_ID);</span><br><span class="line">        log.info(<span class="string">"断开客户端连接:channelId=&#123;&#125;"</span>, channelId);</span><br><span class="line">        <span class="comment">// 移除session</span></span><br><span class="line">        wsSessionManager.remove(channelId.toString());</span><br><span class="line">        log.info(<span class="string">"Session移除成功:channelId=&#123;&#125;"</span>, channelId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Session管理器"><a href="#Session管理器" class="headerlink" title="Session管理器"></a>Session管理器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Session管理器，用于管理session，并注册成spring的一个Bean</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WsSessionManager</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 使用ConcurrentHashMap在多线程修改时保证线程安全</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, WebSocketSession&gt; </span><br><span class="line">      SESSION_POOL = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 托管连接</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(String id, WebSocketSession session)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> WebSocketSession oldSession = get(id);</span><br><span class="line">        <span class="keyword">if</span> (oldSession != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (oldSession.isOpen()) &#123;</span><br><span class="line">              <span class="comment">// 同频道的连接存在并且活跃的状态的话，托管失败</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//  移除失效的的老连接</span></span><br><span class="line">            remove(id);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// 加入Map容器进行托管</span></span><br><span class="line">        SESSION_POOL.put(id, session);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取连接</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WebSocketSession <span class="title">get</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SESSION_POOL.get(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 移除连接</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WebSocketSession <span class="title">remove</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 从Map容器中移除</span></span><br><span class="line">        <span class="keyword">final</span> WebSocketSession session = SESSION_POOL.remove(id);</span><br><span class="line">        <span class="keyword">if</span> (session != <span class="keyword">null</span> &amp;&amp; session.isOpen()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// 移除后关闭连接</span></span><br><span class="line">                session.close();</span><br><span class="line">            &#125;<span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                log.error(String.format(<span class="string">"Session关闭异常, channelId=%s"</span>, id), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> session;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="配置WS"><a href="#配置WS" class="headerlink" title="配置WS"></a>配置WS</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">这是一个配置Bean，实现了WebSocketConfigurer接口</span></span><br><span class="line"><span class="comment">使用@Configuration注解将该类注册成一个配置类</span></span><br><span class="line"><span class="comment">使用@EnableWebSocket开启WebSocket自动配置</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocket</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketConfig</span> <span class="keyword">implements</span> <span class="title">WebSocketConfigurer</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 注入握手拦截器</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> CustomHandshakeInterceptor customHandshakeInterceptor;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 注入消息处理器</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> CustomWebSocketHandler customWebSocketHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerWebSocketHandlers</span><span class="params">(WebSocketHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 注册消息处理器，并使用 "/channel"作为处理器的标识，客户端连接路径使用"/channel"就把请求发送给指定的处理器</span></span><br><span class="line">        registry.addHandler(customWebSocketHandler, <span class="string">"/channel"</span>) </span><br><span class="line">                .addInterceptors(customHandshakeInterceptor) <span class="comment">// 注册拦截器</span></span><br><span class="line">                .setAllowedOrigins(<span class="string">"*"</span>); <span class="comment">// 允许跨域</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此基本的ws服务搭建完成。启动服务，使用客户端连接使用</p>
<p>提供一个简单的前端代码，通过控制台简单使用</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"token"</span> <span class="attr">id</span>=<span class="string">"token"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"channelId"</span> <span class="attr">id</span>=<span class="string">"channelId"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"连接"</span> <span class="attr">onclick</span>=<span class="string">"link()"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"关闭"</span> <span class="attr">onclick</span>=<span class="string">"close()"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> ws</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> timer</span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">link</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 打开一个 web socket</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> token = <span class="built_in">document</span>.getElementById(<span class="string">"token"</span>).value</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> channelId = <span class="built_in">document</span>.getElementById(<span class="string">"channelId"</span>).value</span></span><br><span class="line"><span class="javascript">        ws = <span class="keyword">new</span> WebSocket(<span class="string">`ws://localhost:8080/channel?token=<span class="subst">$&#123;token&#125;</span>&amp;channelId=<span class="subst">$&#123;channelId&#125;</span>`</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        ws.onopen = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"连接完成，可以发送数据"</span>);</span></span><br><span class="line"><span class="actionscript">          <span class="comment">// 固定频率发送消息保持连接在线</span></span></span><br><span class="line"><span class="javascript">            timer = setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                ws.send(<span class="built_in">Date</span>.now())</span></span><br><span class="line">            &#125;, 10000)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        ws.onmessage = <span class="function"><span class="keyword">function</span> <span class="params">(evt)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> received_msg = evt.data;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"数据已接收..."</span>);</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(received_msg)</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        ws.onclose = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 关闭 websocket</span></span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"连接已关闭..."</span>);</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        ws.onerror = <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.error(err)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">if</span> (ws === <span class="literal">null</span> || ws === <span class="literal">undefined</span>) &#123;</span></span><br><span class="line"><span class="actionscript">            alert(<span class="string">"请先连接"</span>)</span></span><br><span class="line">        &#125;</span><br><span class="line">        ws.close()</span><br><span class="line">        if (!timer) &#123;</span><br><span class="line"><span class="actionscript">            alert(<span class="string">"请先连接"</span>)</span></span><br><span class="line">        &#125;</span><br><span class="line">        timer.clear()</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h2 id="实际开发中ws服务设计需要注意的方面"><a href="#实际开发中ws服务设计需要注意的方面" class="headerlink" title="实际开发中ws服务设计需要注意的方面"></a>实际开发中ws服务设计需要注意的方面</h2><h3 id="业务层消息的确认机制"><a href="#业务层消息的确认机制" class="headerlink" title="业务层消息的确认机制"></a>业务层消息的确认机制</h3><p>虽然WS是基于TCP连接的通讯机制，TCP协议特性能保证传输层一定能成功发送数据。但是对于复杂业务和可靠性要求高的业务，最佳的实践是在业务层进行消息的确认。服务端对每一条消息映射一个唯一的标识，客户端在收到消息后，需要将该消息的唯一标识返回给服务端。否则服务端进行一定次数的重试推送，从而来保证消息的可靠推送。</p>
<h3 id="心跳机制"><a href="#心跳机制" class="headerlink" title="心跳机制"></a>心跳机制</h3><p>对于服务侧重在服务端消息推送的业务。那客户端需要随时保持对连接的监听，而长时间没有数据来往的情况下，不同的客户端和服务端实现会尝试关闭连接。所以为了保证服务端的及时推送，客户端需要和服务端保持一定频率的心跳连接。</p>
<ul>
<li>可以定时的往服务端发送消息，如果发现连接断开，则重新发起连接请求</li>
<li>可以服务端对客户端发送ping操作，客户端响应pong操作来实现心跳</li>
</ul>
<h3 id="分布式多实例部署的ws服务session的共享问题"><a href="#分布式多实例部署的ws服务session的共享问题" class="headerlink" title="分布式多实例部署的ws服务session的共享问题"></a>分布式多实例部署的ws服务session的共享问题</h3><p>由于ws连接的特殊性，即连接是有状态的。所以一旦连接断开后状态就消失了，下次再进行连接时和上一次的连接并不能对应上。所以平常Web开发中常用的基于序列化和反序列化机制的外部缓存对于面向长连接的ws来说是无法实现的。所以需要通过下面的几种机制来实现</p>
<h4 id="定向分配机制"><a href="#定向分配机制" class="headerlink" title="定向分配机制"></a>定向分配机制</h4><p>配备服务的连接注册中心，将用户和真实连接的节点进行映射。在需要向某一个指定用户推送消息时，通过连接注册中心找到当前处理当前用户连接的真实节点，然后将消息推送给处理节点，处理节点转发消息给用户。</p>
<p><strong>优点</strong>：推送精准，避免无效的广播开销，架构可以根据业务压力的增加进行水平的扩展，适用于大型服务架构</p>
<p><strong>缺点</strong>：实现复杂，需要独立开发一个分布式的连接管理中心。生产上需要高可用架构的设计</p>
<h4 id="MQ或总线的广播机制"><a href="#MQ或总线的广播机制" class="headerlink" title="MQ或总线的广播机制"></a>MQ或总线的广播机制</h4><p>通过MQ或Redis的消息订阅和发布机制，进行消息的广播。将ws服务节点接入到统一的MQ或者Redis中，订阅同一个主题或频道。当需要发送消息的时候，将消息广播给所有节点，节点收到广播后会去匹配当前消息的目标连接是否在本节点上。如果在本节点就进行消息推送。不在本节点就自动忽略。</p>
<p><strong>优点</strong>：实现简单，维护方便。架构上只需引入一个MQ或Redis中间件。适合ws服务节点规模不大的场景</p>
<p><strong>缺点</strong>：需要良好的代码实现，搞不好容易发生广播风暴，拖垮集群。而且一般一个用户只会连接在集群中的某一个节点，而将消息广播给每一个节点，其实是没必要的。当集群规模扩张到一定程度，当发送一个广播后，所有节点开始计算，导致集群的计算负载短时间内出现峰值。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>实际开发中，如果预测到集群规模不大的情况。可以优先考虑使用广播机制进行消息广播。但集群规模很大的情况下，考虑定向分配的架构设计。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://zh.wikipedia.org/wiki/WebSocket" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/WebSocket</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1530872" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1530872</a></li>
<li><a href="https://tools.ietf.org/html/rfc6455#section-5.2" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc6455#section-5.2</a></li>
</ul>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">沐风</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.mufeng.tech/public/2020/06/02/WebSocket%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3%E4%BB%A5%E5%8F%8A%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/">https://blog.mufeng.tech/public/2020/06/02/WebSocket%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3%E4%BB%A5%E5%8F%8A%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.mufeng.tech/public" target="_blank">沐风技术博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/public/tags/WebSocket/">WebSocket</a><a class="post-meta__tags" href="/public/tags/Spring/">Spring</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/06/02/AU7RhwT5BvkrPqd.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/public/images/wechart_pay_qrcode.png" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/public/images/alipay_qrcode.png" alt="支付宝"/><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="next-post pull-full"><a href="/public/2020/05/25/HashMap%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><img class="next_cover" data-src="https://i.loli.net/2020/06/02/RBHFrCTbui91Ltn.png" onerror="onerror=null;src='/public/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">HashMap源码分析</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By 沐风</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">简</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/public/js/utils.js"></script><script src="/public/js/main.js"></script><script src="/public/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script></body></html>